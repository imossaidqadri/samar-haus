{% comment %}
  Renders a product card

  Accepts:
  - card_product: {Object} Product Liquid object (optional)
  - media_aspect_ratio: {String} Size of the product image card. Values are "square" and "portrait". Default is "square" (optional)
  - image_shape: {String} Image mask to apply to the product image card. Values are "arch", "blob", "chevronleft", "chevronright", "diamond", "parallelogram", and "round". (optional)
  - show_secondary_image: {Boolean} Show the secondary image on hover. Default: false (optional)
  - show_vendor: {Boolean} Show the product vendor. Default: false
  - show_rating: {Boolean} Show the product rating. Default: false
  - section_id: {String} The ID of the section that contains this card.
  - quick_add: {String} The quick add type. Values are "standard", "bulk", and "none" (optional)

  Usage:
  {% render 'card-product', show_vendor: section.settings.show_vendor %}
{% endcomment %}

{{ 'component-rating.css' | asset_url | stylesheet_tag }}
{{ 'component-volume-pricing.css' | asset_url | stylesheet_tag }}

{%- if card_product and card_product != empty -%}
  {%- liquid
    assign ratio = 1
    if media_aspect_ratio == 'portrait'
      assign ratio = 0.8
    endif
  -%}
  
  {%- comment -%} WRAP ENTIRE CARD IN LINK {%- endcomment -%}
  <a 
    href="{{ card_product.url }}" 
    class="group block w-full h-full bg-white rounded-lg shadow-sm hover:shadow-md transition-all duration-300 overflow-hidden"
    aria-label="View {{ card_product.title | escape }}"
  >
    <div class="relative w-full h-full flex flex-col">
      
      {%- comment -%} Product Image {%- endcomment -%}
      {%- if card_product.featured_media -%}
        <div 
          class="
            relative overflow-hidden bg-neutral-100
            {% case media_aspect_ratio %}
              {% when 'portrait' %}aspect-[4/5]
              {% when 'square' %}aspect-square
              {% else %}aspect-square
            {% endcase %}
          "
        >
          <img
            src="{{ card_product.featured_media | image_url: width: 533 }}"
            srcset="
              {%- if card_product.featured_media.width >= 165 -%}{{ card_product.featured_media | image_url: width: 165 }} 165w,{%- endif -%}
              {%- if card_product.featured_media.width >= 360 -%}{{ card_product.featured_media | image_url: width: 360 }} 360w,{%- endif -%}
              {%- if card_product.featured_media.width >= 533 -%}{{ card_product.featured_media | image_url: width: 533 }} 533w,{%- endif -%}
              {{ card_product.featured_media | image_url }} {{ card_product.featured_media.width }}w
            "
            alt="{{ card_product.featured_media.alt | escape }}"
            class="
              w-full h-full object-cover group-hover:scale-105 transition-transform duration-300
              {% if image_shape == 'diamond' %}-rotate-45{% endif %}
            "
            loading="lazy"
            width="{{ card_product.featured_media.width }}"
            height="{{ card_product.featured_media.height }}"
          >

          {%- comment -%} Secondary Image on Hover {%- endcomment -%}
          {%- if show_secondary_image and card_product.media[1] != null -%}
            <img
              src="{{ card_product.media[1] | image_url: width: 533 }}"
              srcset="
                {%- if card_product.media[1].width >= 165 -%}{{ card_product.media[1] | image_url: width: 165 }} 165w,{%- endif -%}
                {%- if card_product.media[1].width >= 360 -%}{{ card_product.media[1] | image_url: width: 360 }} 360w,{%- endif -%}
                {%- if card_product.media[1].width >= 533 -%}{{ card_product.media[1] | image_url: width: 533 }} 533w,{%- endif -%}
                {{ card_product.media[1] | image_url }} {{ card_product.media[1].width }}w
              "
              alt=""
              class="
                absolute inset-0 w-full h-full object-cover opacity-0 group-hover:opacity-100 transition-opacity duration-300
                {% if image_shape == 'diamond' %}-rotate-45{% endif %}
              "
              loading="lazy"
              width="{{ card_product.media[1].width }}"
              height="{{ card_product.media[1].height }}"
            >
          {%- endif -%}

          {%- comment -%} Product Badges {%- endcomment -%}
          <div class="absolute top-2 left-2 z-10">
            {%- if card_product.available == false -%}
              <span class="bg-neutral-900 text-white px-2 py-1 text-xs font-medium rounded">
                {{ 'products.product.sold_out' | t }}
              </span>
            {%- elsif card_product.compare_at_price > card_product.price and card_product.available -%}
              <span class="bg-red-500 text-white px-2 py-1 text-xs font-medium rounded">
                {{ 'products.product.on_sale' | t }}
              </span>
            {%- endif -%}
          </div>
        </div>
      {%- else -%}
        {%- comment -%} Placeholder when no image {%- endcomment -%}
        <div 
          class="
            relative bg-neutral-200
            {% case media_aspect_ratio %}
              {% when 'portrait' %}aspect-[4/5]
              {% when 'square' %}aspect-square
              {% else %}aspect-square
            {% endcase %}
          "
        >
          {{ 'product-1' | placeholder_svg_tag: 'w-full h-full object-cover text-neutral-400' }}
        </div>
      {%- endif -%}

      {%- comment -%} Product Content {%- endcomment -%}
      <div class="p-4 flex flex-col flex-grow">
        
        {%- comment -%} Vendor {%- endcomment -%}
        {%- if show_vendor -%}
          <p class="text-sm text-neutral-500 mb-1">{{ card_product.vendor }}</p>
        {%- endif -%}

        {%- comment -%} Product Title {%- endcomment -%}
        <h3 class="text-lg font-medium text-neutral-900 mb-2 line-clamp-2 group-hover:text-neutral-700 transition-colors duration-200">
          {{ card_product.title | escape }}
        </h3>

        {%- comment -%} Rating {%- endcomment -%}
        {%- if show_rating and card_product.metafields.reviews.rating.value != blank -%}
          <div class="flex items-center mb-2">
            <div class="flex items-center">
              {%- assign rating = card_product.metafields.reviews.rating.value.rating -%}
              {%- assign max_rating = card_product.metafields.reviews.rating.value.scale_max -%}
              {%- for i in (1..max_rating) -%}
                <svg
                  class="w-4 h-4 {% if i <= rating %}text-yellow-400{% else %}text-neutral-300{% endif %}"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                </svg>
              {%- endfor -%}
            </div>
            <span class="ml-2 text-sm text-neutral-600">({{ card_product.metafields.reviews.rating_count }})</span>
          </div>
        {%- endif -%}

        {%- comment -%} Price {%- endcomment -%}
        <div class="mt-auto">
          <div class="flex items-center space-x-2">
            <span class="text-sm font-semibold text-neutral-900">
              {{ card_product.price | money }}
            </span>
            {%- if card_product.compare_at_price > card_product.price -%}
              <span class="text-sm text-neutral-500 line-through">
                {{ card_product.compare_at_price | money }}
              </span>
            {%- endif -%}
          </div>

          {%- comment -%} Volume Pricing Note {%- endcomment -%}
          {%- if card_product.quantity_price_breaks_configured? -%}
            <div class="mt-1">
              <span class="text-xs text-neutral-500">
                {{ 'products.product.quantity_discount_available' | t }}
              </span>
            </div>
          {%- endif -%}

          {%- comment -%} Unit price {%- endcomment -%}
          {%- if card_product.selected_or_first_available_variant.unit_price_measurement -%}
            <div class="mt-1">
              <span class="text-xs text-neutral-500">
                {{ card_product.selected_or_first_available_variant.unit_price | money }}/
                {%- if card_product.selected_or_first_available_variant.unit_price_measurement.reference_value != 1 -%}
                  {{ card_product.selected_or_first_available_variant.unit_price_measurement.reference_value }}
                {%- endif -%}
                {{ card_product.selected_or_first_available_variant.unit_price_measurement.reference_unit }}
              </span>
            </div>
          {%- endif -%}
        </div>

        {%- comment -%} Quick Add Button {%- endcomment -%}
        {%- if quick_add == 'standard' and card_product.available -%}
          <div class="mt-3" onclick="event.preventDefault(); event.stopPropagation();">
            <button 
              type="button"
              class="w-full bg-neutral-900 text-white py-2 px-4 rounded hover:bg-neutral-800 transition-colors duration-200 text-sm font-medium"
              onclick="quickAddToCart({{ card_product.selected_or_first_available_variant.id }})"
            >
              {{ 'products.product.add_to_cart' | t }}
            </button>
          </div>
        {%- endif -%}
      </div>
    </div>
  </a>

{%- else -%}
  {%- comment -%} Placeholder product card {%- endcomment -%}
  <div class="block w-full h-full bg-white rounded-lg shadow-sm overflow-hidden">
    <div class="relative w-full h-full flex flex-col">
      <div 
        class="
          relative bg-neutral-200
          {% case media_aspect_ratio %}
            {% when 'portrait' %}aspect-[4/5]
            {% when 'square' %}aspect-square
            {% else %}aspect-square
          {% endcase %}
        "
      >
        {{ 'product-1' | placeholder_svg_tag: 'w-full h-full object-cover text-neutral-400' }}
      </div>
      
      <div class="p-4 flex flex-col flex-grow">
        <h3 class="font-medium text-neutral-900 mb-2">
          {{ 'onboarding.product_title' | t }}
        </h3>
        <div class="mt-auto">
          <span class="text-lg font-semibold text-neutral-900">
            {{ 1999 | money }}
          </span>
        </div>
      </div>
    </div>
  </div>
{%- endif -%}

{%- comment -%} Quick Add Script {%- endcomment -%}
{%- if quick_add == 'standard' -%}
  <script>
    function quickAddToCart(variantId) {
      fetch('/cart/add.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          id: variantId,
          quantity: 1
        })
      })
      .then(response => response.json())
      .then(data => {
        // Update cart drawer or show notification
        console.log('Product added to cart:', data);
        // You can add your cart update logic here
      })
      .catch(error => {
        console.error('Error adding to cart:', error);
      });
    }
  </script>
{%- endif -%}